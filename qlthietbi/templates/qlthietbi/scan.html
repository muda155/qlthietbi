{% extends 'qlthietbi/base.html' %}

{% block title %}Quét mã - Sổ Kỹ Thuật Số{% endblock %}

{% block extra_css %}
<style>
    /* KHUNG CHỨA: Giới hạn chiều cao để không chiếm hết màn hình */
    #qr-reader {
        width: 100%;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    /* VIDEO: Quan trọng nhất */
    #qr-reader video {
        /* Dùng contain để nhìn thấy TOÀN BỘ video, không bị cắt cúp */
        object-fit: contain !important; 
        width: 100% !important;
        height: auto !important;
        max-height: 60vh !important; /* Giới hạn chiều cao tối đa 60% màn hình */
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h1 class="h4 mb-3 text-light">
            <i class="fas fa-qrcode me-2"></i>Quét mã thiết bị
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-12 mx-auto">
        <!-- QR Scanner Preview -->
        <div class="card mb-3 bg-dark border-secondary">
            <div class="card-body p-1">
                <div id="qr-reader"></div>
            </div>
            <!-- Nút đổi Camera thủ công (Nếu máy tự chọn sai) -->
            <div class="card-footer bg-transparent border-0 text-center">
                <button class="btn btn-outline-light btn-sm" onclick="restartScanner()">
                    <i class="fas fa-sync-alt me-2"></i>Đổi Camera
                </button>
            </div>
        </div>

        <!-- Status Message -->
        <div id="scan-message" class="alert alert-info" role="alert" style="display: none;">
            <i class="fas fa-spinner fa-spin me-2"></i>
            <span id="scan-text">Đang xử lý...</span>
        </div>

        <!-- Manual Input -->
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <form id="manual-qr-form" class="d-flex gap-2">
                    <input 
                        type="text" 
                        class="form-control bg-secondary text-white border-0" 
                        id="manual-qr-code" 
                        placeholder="Nhập mã (VD: GKU5-R1)"
                        autocomplete="off"
                    >
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    let html5QrcodeScanner = null;
    let currentFacingMode = "environment"; // Mặc định dùng Camera sau

    function onScanSuccess(decodedText, decodedResult) {
        // Dừng camera ngay
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
        }

        const message = document.getElementById('scan-message');
        const text = document.getElementById('scan-text');
        
        message.style.display = 'block';
        message.className = 'alert alert-success';
        text.textContent = 'Đã tìm thấy: ' + decodedText;

        setTimeout(() => {
            window.location.href = `/thiet-bi/${encodeURIComponent(decodedText)}/`;
        }, 500);
    }

    function startScanner(facingMode) {
        // Nếu đang chạy thì tắt đi bật lại
        if (html5QrcodeScanner) {
            try { html5QrcodeScanner.clear(); } catch(e){}
        }

        const config = { 
            fps: 10,
            // qrbox dạng hàm: Tự động lấy 60% chiều rộng video làm vùng quét
            qrbox: function(viewfinderWidth, viewfinderHeight) {
                let minEdgePercentage = 0.6; 
                let minSize = Math.min(viewfinderWidth, viewfinderHeight);
                let qrboxSize = Math.floor(minSize * minEdgePercentage);
                return { width: qrboxSize, height: qrboxSize };
            },
            // BỎ aspectRatio để video tự nhiên theo màn hình Tablet
            videoConstraints: {
                facingMode: facingMode 
            }
        };

        html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", config, false);
        html5QrcodeScanner.render(onScanSuccess, (err) => {});
    }

    // Hàm đổi camera (Nút bấm)
    function restartScanner() {
        // Đảo chiều camera: Nếu đang Sau -> Trước, đang Trước -> Sau
        currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
        startScanner(currentFacingMode);
    }

    // Form nhập tay
    document.getElementById('manual-qr-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const qrCode = document.getElementById('manual-qr-code').value.trim();
        if (qrCode) window.location.href = `/thiet-bi/${encodeURIComponent(qrCode)}/`;
    });

    // Chạy ngay khi load
    document.addEventListener('DOMContentLoaded', function() {
        // Thử khởi động với camera sau (environment)
        startScanner(currentFacingMode);
    });
</script>
{% endblock %}
